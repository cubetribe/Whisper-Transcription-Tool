{% extends "base.html" %}

{% block content %}
<div class="model-management-section">

    <div class="form-group">
        <label for="model-directory">Aktueller Modell-Speicherort:</label>
        <input type="text" id="model-directory-display" value="{{ model_directory }}" readonly class="form-control" style="margin-bottom: 10px;">
        <button id="browse-model-dir" class="btn btn-secondary">Speicherort ändern...</button> 
        <p><small>Hier werden die Whisper-Modelle (.bin Dateien) gespeichert.</small></p>
    </div>

    <hr>

    <h2>Verfügbare Modelle</h2>
 
    <p>
        Aktuelles Modell-Verzeichnis: <code id="current-model-directory">{{ model_directory }}</code>
    </p>
    
    <div class="alert alert-info">
        <h5>Modell-Empfehlungen:</h5>
        <ul>
            <li><strong>Tiny/Base:</strong> Für Geräte mit begrenzten Ressourcen oder wenn Geschwindigkeit wichtiger ist als Genauigkeit.</li>
            <li><strong>Medium:</strong> Guter Kompromiss für die meisten Anwendungsfälle.</li>
            <li><strong>Large-v3:</strong> Höchste Genauigkeit, ideal für professionelle Transkriptionen.</li>
            <li><strong>Large-v3-Turbo:</strong> Fast so genau wie Large-v3, aber deutlich schneller.</li>
        </ul>
        <p><small>Die englischen Modelle (.en) sind für englische Inhalte optimiert und liefern dort bessere Ergebnisse.</small></p>
    </div>

    <div class="form-group">
        <label for="new-model-directory">Neues Modell-Verzeichnis:</label>
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="new-model-directory" placeholder="Gib einen neuen Pfad ein (z.B. /pfad/zu/modellen oder ~/meine_modelle)" value="{{ model_directory }}">
            <div class="input-group-append">
                <button class="btn btn-primary" type="button" id="set-directory-btn">Speichern</button>
            </div>
        </div>
    </p>

    <ul class="nav nav-tabs" id="modelTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="recommended-tab" data-bs-toggle="tab" data-bs-target="#recommended" type="button" role="tab" aria-controls="recommended" aria-selected="true">Empfohlene Modelle</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="all-models-tab" data-bs-toggle="tab" data-bs-target="#all-models" type="button" role="tab" aria-controls="all-models" aria-selected="false">Alle Modelle</button>
        </li>
    </ul>
    
    <div class="tab-content" id="modelTabsContent">
        <div class="tab-pane fade show active" id="recommended" role="tabpanel" aria-labelledby="recommended-tab">
            <div class="table-responsive">
                <table class="table table-striped table-hover mt-3">
                    <thead>
                        <tr>
                            <th>Modellname</th>
                            <th>Größe</th>
                            <th>Beschreibung</th>
                            <th>Status</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody id="recommended-models-body">
                        <!-- Wird per JavaScript gefüllt -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="tab-pane fade" id="all-models" role="tabpanel" aria-labelledby="all-models-tab">
            <div class="table-responsive">
                <table class="table table-striped table-hover mt-3">
                    <thead>
                        <tr>
                            <th>Modellname</th>
                            <th>Größe</th>
                            <th>Status</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody id="all-models-body">
                        <!-- Wird per JavaScript gefüllt -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    

    
    <!-- Inline-Fortschrittsanzeige für jeden Download direkt in der Tabelle -->
    <div class="alert alert-info mt-3" id="download-info" style="display: none;">
        <h5>Download läuft: <span id="current-download-model"></span></h5>
        <p class="text-muted small mb-1">Letztes Update: <span id="last-update-time">-</span></p>
        <div class="progress mb-2">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 id="inline-progress-bar" 
                 role="progressbar" 
                 aria-valuenow="0" 
                 aria-valuemin="0" 
                 aria-valuemax="100" 
                 style="width: 0%">
                0%
            </div>
        </div>
        <div class="row text-center small">
            <div class="col">Größe: <span id="inline-size">0</span> MB</div>
            <div class="col">Heruntergeladen: <span id="inline-downloaded">0</span> MB</div>
            <div class="col">Geschwindigkeit: <span id="inline-speed">0</span> MB/s</div>
            <div class="col">Verbleibend: <span id="inline-eta">Berechne...</span></div>
        </div>
        <!-- Detaillierte Statusinformationen -->
        <div class="mt-2 text-center">
            <code class="small" id="progress-details">Warte auf Fortschrittsinformationen...</code>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
// WebSocket-Verbindung initialisieren
let socket = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log("Model management page loaded.");
    
    // WebSocket beim Laden der Seite initialisieren
    connectWebSocket();
    
    const browseButton = document.getElementById('browse-model-dir');
    const progressContainer = document.getElementById('download-progress');
    const progressBar = document.getElementById('model-progress-bar');
    const progressStatus = document.getElementById('progress-status');
    const recommendedModelsBody = document.getElementById('recommended-models-body');
    const allModelsBody = document.getElementById('all-models-body');

    // Lade Modellinformationen
    loadModels();
    
    function loadModels() {
        fetch('/api/models')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Empfohlene Modelle anzeigen
                    displayRecommendedModels(data.recommended_models);
                    
                    // Alle Modelle anzeigen (empfohlene + legacy)
                    displayAllModels(data.recommended_models, data.legacy_models);
                } else {
                    console.error('Fehler beim Laden der Modelle:', data.error);
                }
            })
            .catch(error => {
                console.error('Fehler beim Laden der Modelle:', error);
            });
    }
    
    function displayRecommendedModels(models) {
        recommendedModelsBody.innerHTML = '';
        models.forEach(model => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${model.name}</td>
                <td>${model.size_mb} MB</td>
                <td>
                    <div>${model.description}</div>
                    <div class="text-muted small mt-1">${model.recommendation}</div>
                </td>
                <td>
                    ${model.is_downloaded ? 
                        '<span class="badge bg-success">Heruntergeladen</span>' : 
                        '<span class="badge bg-warning text-dark">Nicht heruntergeladen</span>'}
                </td>
                <td>
                    ${model.is_downloaded ? 
                        '<button class="btn btn-danger btn-sm delete-btn" data-model="' + model.name + '">Löschen</button>' : 
                        '<button class="btn btn-primary btn-sm download-btn" data-model="' + model.name + '">Download</button>'}
                </td>
            `;
            recommendedModelsBody.appendChild(row);
        });
        attachDownloadHandlers();
    }
    
    function displayAllModels(recommendedModels, legacyModels) {
        allModelsBody.innerHTML = '';
        const allModels = [...recommendedModels, ...legacyModels];
        allModels.forEach(model => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${model.name}${model.is_legacy ? ' <span class="badge bg-secondary">Legacy</span>' : ''}</td>
                <td>${model.size_mb > 0 ? model.size_mb + ' MB' : 'Unbekannt'}</td>
                <td>
                    ${model.is_downloaded ? 
                        '<span class="badge bg-success">Heruntergeladen</span>' : 
                        '<span class="badge bg-warning text-dark">Nicht heruntergeladen</span>'}
                </td>
                <td>
                    ${model.is_downloaded ? 
                        '<button class="btn btn-danger btn-sm delete-btn" data-model="' + model.name + '">Löschen</button>' : 
                        '<button class="btn btn-primary btn-sm download-btn" data-model="' + model.name + '">Download</button>'}
                </td>
            `;
            allModelsBody.appendChild(row);
        });
        attachDownloadHandlers();
    }
    
    function attachDownloadHandlers() {
        // Bestehende Event-Handler entfernen, um Doppelbindungen zu vermeiden
        const downloadButtons = document.querySelectorAll('.download-btn');
        const deleteButtons = document.querySelectorAll('.delete-btn');
        
        downloadButtons.forEach(button => {
            button.removeEventListener('click', handleDownloadClick);
            button.addEventListener('click', handleDownloadClick);
        });
        
        deleteButtons.forEach(button => {
            button.removeEventListener('click', handleDeleteClick);
            button.addEventListener('click', handleDeleteClick);
        });
    }

    function handleDownloadClick(event) {
        const modelName = event.target.getAttribute('data-model');
        console.log(`Starting download for model: ${modelName}`);
        
        // Button während der Anfrage deaktivieren
        event.target.disabled = true;
        event.target.textContent = 'Wird angefordert...';
        
        // Alle anderen Download-Buttons deaktivieren
        document.querySelectorAll('.download-btn').forEach(btn => {
            if (btn !== event.target) {
                btn.disabled = true;
                btn.title = 'Es läuft bereits ein Download';
            }
        });

        // Zeige Fortschrittsanzeige direkt im Hauptbereich
        document.getElementById('download-info').style.display = 'block';
        document.getElementById('current-download-model').textContent = modelName;
        
        fetch(`/api/models/download/${modelName}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Download request response:', data);
            // Der Rest wird durch den WebSocket-Handler erledigt
        })
        .catch(error => {
            console.error('Error requesting model download:', error);
            alert(`Fehler bei der Anfrage für ${modelName}.`);
            resetDownloadUI();
        });
    }

    function handleDeleteClick(event) {
        const modelName = event.target.getAttribute('data-model');
        console.log(`Requesting deletion for model: ${modelName}`);
        
        // Button während der Anfrage deaktivieren
        event.target.disabled = true;
        event.target.textContent = 'Wird gelöscht...';
        
        fetch(`/api/models/delete/${modelName}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Delete request response:', data);
            if (data.success) {
                alert(`Modell ${modelName} erfolgreich gelöscht!`);
                loadModels();
            } else {
                alert(`Fehler beim Löschen des Modells ${modelName}: ${data.error}`);
                event.target.disabled = false;
                event.target.textContent = 'Löschen';
            }
        })
        .catch(error => {
            console.error('Error requesting model deletion:', error);
            alert(`Fehler bei der Anfrage für ${modelName}.`);
            event.target.disabled = false;
            event.target.textContent = 'Löschen';
        });
    }

    // Verzeichnis-Auswahl
    browseButton.addEventListener('click', function() {
        alert("Funktion zum Ändern des Verzeichnisses noch nicht implementiert.");
        // In einer Produktionsversion würde hier ein Verzeichnisauswahl-Dialog geöffnet
    });

    // Handler für das Setzen des Modell-Verzeichnisses
    const setDirectoryBtn = document.getElementById('set-directory-btn');
    const newDirectoryInput = document.getElementById('new-model-directory');

    setDirectoryBtn.addEventListener('click', () => {
        const newPath = newDirectoryInput.value.trim();
        if (!newPath) {
            alert('Bitte gib einen Pfad für das Modell-Verzeichnis ein.');
            return;
        }

        console.log(`Sende Anfrage zum Setzen des Verzeichnisses auf: ${newPath}`);

        fetch('/api/models/set-directory', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ directory: newPath })
        })
        .then(response => {
            if (!response.ok) {
                // Versuche, Fehlerdetails aus der JSON-Antwort zu lesen
                return response.json().then(err => {
                    throw new Error(err.detail || `HTTP-Fehler ${response.status}`);
                }).catch(() => {
                     // Fallback, wenn keine JSON-Antwort vorhanden ist
                    throw new Error(`HTTP-Fehler ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Antwort vom Server (Verzeichnis setzen):', data);
            if (data.status === 'success') {
                alert(data.message || 'Modellverzeichnis erfolgreich aktualisiert!');
                window.location.reload(); // Seite neu laden, um Änderungen anzuzeigen
            } else {
                alert(`Fehler: ${data.message || 'Unbekannter Fehler beim Setzen des Verzeichnisses.'}`);
            }
        })
        .catch(error => {
            console.error('Fehler beim Setzen des Modell-Verzeichnisses:', error);
            alert(`Ein Fehler ist aufgetreten: ${error.message}`);
        });
    });
});

// --- WebSocket Logic for Progress Updates ---
const progressModal = new bootstrap.Modal(document.getElementById('downloadProgressModal'));
const progressModelName = document.getElementById('progress-model-name');
const progressStatus = document.getElementById('progress-status');
const progressBar = document.getElementById('progress-bar');
const progressSize = document.getElementById('progress-size');
const progressDownloaded = document.getElementById('progress-downloaded');
const progressSpeed = document.getElementById('progress-speed');
const progressEta = document.getElementById('progress-eta');
const progressMessage = document.getElementById('progress-message');
const closeProgressModalBtn = document.getElementById('close-progress-modal-btn');

let currentDownloadingModel = null; // Track which model's progress is shown

// Function to format ETA seconds into minutes/seconds string
function formatEta(seconds) {
    if (seconds === null || seconds === undefined || seconds < 0) return 'N/A';
    if (seconds === 0) return 'Fertig';
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.round(seconds % 60);
    let etaStr = '';
    if (minutes > 0) {
        etaStr += `${minutes} Min `;
    }
    etaStr += `${remainingSeconds} Sek`;
    return etaStr;
}

// Hilfsfunktion zum Zurücksetzen der Download-UI
function resetDownloadUI() {
    // Verstecke Fortschrittsanzeige
    document.getElementById('download-info').style.display = 'none';
    
    // Setze Fortschrittsbalken zurück
    const progressBar = document.getElementById('inline-progress-bar');
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    progressBar.setAttribute('aria-valuenow', '0');
    progressBar.classList.remove('bg-success', 'bg-danger');
    progressBar.classList.add('progress-bar-animated', 'progress-bar-striped');
    
    // Aktiviere alle Download-Buttons wieder
    document.querySelectorAll('.download-btn').forEach(btn => {
        btn.disabled = false;
        btn.textContent = 'Download';
        btn.title = '';
    });
    
    currentDownloadingModel = null;
}

// Socket ist bereits global definiert

function connectWebSocket() {
    // Schließe bestehende Verbindung, falls vorhanden
    if (socket && socket.readyState !== WebSocket.CLOSED) {
        console.log('Closing existing WebSocket connection');
        socket.close();
    }
    
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws/progress`;
    console.log(`Connecting to WebSocket: ${wsUrl}`);

    // Neue Verbindung herstellen
    socket = new WebSocket(wsUrl);

    socket.onopen = (event) => {
        console.log('WebSocket connection established successfully.');
        document.getElementById('progress-details').textContent = 'WebSocket verbunden. Bereit für Updates.';
        
        // DEBUG: Ping senden, um zu testen, ob die Verbindung aktiv ist
        setTimeout(() => {
            try {
                socket.send('ping');
                console.log('Ping sent to server');
            } catch (error) {
                console.error('Error sending ping:', error);
            }
        }, 1000);
    };

    socket.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            console.log('WebSocket message received:', data);
            console.info(`Progress Update: ${data.model_name || 'unknown'} - ${data.status || 'unknown'} - ${data.progress || 0}%`);
            
            // Zeige die inline-Fortschrittsanzeige an
            if (data.status === 'starting' || data.status === 'downloading') {
                currentDownloadingModel = data.model_name;
                document.getElementById('download-info').style.display = 'block';
                
                // Zeige detaillierte Modellname und Status an
                const modelName = data.model_name;
                const statusText = data.status === 'starting' ? 'Starte Download...' : 'Wird heruntergeladen...';
                document.getElementById('current-download-model').textContent = `${modelName} (${statusText})`;
                
                // Füge Zeitstempel hinzu
                const timestamp = new Date().toLocaleTimeString();
                document.getElementById('last-update-time').textContent = timestamp;
                
                // Update des inline Fortschrittsbalkens
                const inlineProgressBar = document.getElementById('inline-progress-bar');
                inlineProgressBar.style.width = `${data.progress}%`;
                inlineProgressBar.textContent = `${data.progress}%`;
                inlineProgressBar.setAttribute('aria-valuenow', data.progress);
                
                // Update der Statuswerte mit Formatierung
                document.getElementById('inline-size').textContent = data.total_size_mb;
                document.getElementById('inline-downloaded').textContent = data.downloaded_mb;
                document.getElementById('inline-speed').textContent = data.speed_mbps;
                document.getElementById('inline-eta').textContent = formatEta(data.eta_seconds);
                document.getElementById('progress-details').textContent = data.status;
                inlineProgressBar.classList.remove('bg-danger', 'bg-success');
                inlineProgressBar.classList.add('progress-bar-animated', 'progress-bar-striped');
            } else if (data.status === 'finished') {
                const inlineProgressBar = document.getElementById('inline-progress-bar');
                inlineProgressBar.style.width = '100%';
                inlineProgressBar.textContent = '100%';
                inlineProgressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                inlineProgressBar.classList.add('bg-success');
                document.getElementById('progress-details').textContent = 'Download abgeschlossen';
                setTimeout(() => {
                    resetDownloadUI();
                    loadModels();
                }, 2000);
            } else if (data.status === 'error' || data.status === 'failed') {
                const inlineProgressBar = document.getElementById('inline-progress-bar');
                inlineProgressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                inlineProgressBar.classList.add('bg-danger');
                inlineProgressBar.style.width = '100%';
                inlineProgressBar.textContent = 'Fehler: ' + (data.message || 'Unbekannter Fehler');
                document.getElementById('progress-details').textContent = 'Fehler beim Download';
                setTimeout(() => {
                    resetDownloadUI();
                    loadModels();
                }, 5000);
            }
        } catch (error) {
            console.error('Error processing WebSocket message:', error);
        }
    };

socket.onerror = (error) => {
    console.error('WebSocket Error:', error);
    // Zeige Fehler in der Inline-Anzeige
    const inlineProgressBar = document.getElementById('inline-progress-bar');
    inlineProgressBar.classList.add('bg-danger');
    inlineProgressBar.textContent = 'Verbindungsfehler';
    
    setTimeout(() => {
        resetDownloadUI();  // Nach einigen Sekunden UI zurücksetzen
    }, 3000);
};

    socket.onclose = (event) => {
        console.log(`WebSocket connection closed: ${event.code} ${event.reason}`);
        // If the connection closes unexpectedly while downloading, show error
        if (currentDownloadingModel && (event.code !== 1000)) { // 1000 = Normal closure
             progressStatus.textContent = 'Status: Verbindung getrennt!';
             progressMessage.textContent = 'Die Verbindung zum Server wurde unerwartet geschlossen.';
             progressBar.classList.add('bg-danger');
             closeProgressModalBtn.disabled = false;
        }
        setTimeout(connectWebSocket, 3000); // Attempt to reconnect after 3 seconds
    };
}

// Initial WebSocket connection
connectWebSocket();
</script>
{% endblock %}

<!-- Download Progress Modal -->
<div class="modal fade" id="downloadProgressModal" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="downloadProgressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="downloadProgressModalLabel">Modell-Download Fortschritt</h5>
                <!-- Kein Schließen-Button im Header, um unbeabsichtigtes Schließen zu verhindern -->
            </div>
            <div class="modal-body">
                <h6 id="progress-model-name">Modell: </h6>
                <p id="progress-status" class="font-weight-bold">Status: Warten...</p>
                <div class="progress mb-2" style="height: 20px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <div class="row">
                    <div class="col-6"><small>Größe: <span id="progress-size">N/A</span> MB</small></div>
                    <div class="col-6"><small>Heruntergeladen: <span id="progress-downloaded">N/A</span> MB</small></div>
                </div>
                <div class="row">
                    <div class="col-6"><small>Geschwindigkeit: <span id="progress-speed">N/A</span> Mbps</small></div>
                    <div class="col-6"><small>Verbleibend: <span id="progress-eta">N/A</span></small></div>
                </div>
                <p id="progress-message" class="text-muted mt-2"></p>
            </div>
            <div class="modal-footer">
                 <button type="button" id="close-progress-modal-btn" class="btn btn-secondary" data-dismiss="modal" disabled>Schließen</button>
            </div>
        </div>
    </div>
</div>
