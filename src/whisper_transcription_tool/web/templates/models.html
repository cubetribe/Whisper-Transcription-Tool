{% extends "base.html" %}

{% block content %}
<!-- Header Section -->
<div class="header-section">
    <h1><i class="fas fa-brain"></i> Whisper Modell-Management</h1>
    <div class="status-indicator success">
        <i class="fas fa-database"></i> Models Ready
    </div>
</div>

<!-- Model Directory Configuration -->
<div class="card mb-6">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-folder-open"></i> Modell-Speicherort
        </div>
    </div>

    <div class="form-group">
        <label for="model-directory-display" class="form-label">Aktueller Modell-Speicherort:</label>
        <div class="flex gap-2">
            <input type="text" id="model-directory-display" value="{{ model_directory }}" readonly class="form-input" style="flex: 1;">
            <button id="browse-model-dir" class="btn btn-secondary">
                <i class="fas fa-edit"></i> Ändern
            </button>
        </div>
        <small class="text-muted">Hier werden die Whisper-Modelle (.bin Dateien) gespeichert.</small>
    </div>

    <div class="form-group">
        <label for="new-model-directory" class="form-label">Neues Modell-Verzeichnis:</label>
        <div class="flex gap-2">
            <input type="text" class="form-input" id="new-model-directory"
                   placeholder="Gib einen neuen Pfad ein (z.B. /pfad/zu/modellen oder ~/meine_modelle)"
                   value="{{ model_directory }}" style="flex: 1;">
            <button class="btn btn-primary" type="button" id="set-directory-btn">
                <i class="fas fa-save"></i> Speichern
            </button>
        </div>
    </div>
</div>
<!-- Model Recommendations -->
<div class="card mb-6">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-lightbulb"></i> Modell-Empfehlungen
        </div>
    </div>

    <div class="notification info">
        <i class="fas fa-info-circle"></i>
        <div>
            <p><strong>Aktuelles Modell-Verzeichnis:</strong> <code id="current-model-directory">{{ model_directory }}</code></p>
        </div>
    </div>

    <div class="grid grid-2 mt-4">
        <div class="card card-compact">
            <h5 class="font-semibold text-success mb-3"><i class="fas fa-rocket"></i> Geschwindigkeit</h5>
            <ul class="text-sm">
                <li><strong>Tiny/Base:</strong> Für Geräte mit begrenzten Ressourcen oder wenn Geschwindigkeit wichtiger ist als Genauigkeit.</li>
                <li><strong>Large-v3-Turbo:</strong> Fast so genau wie Large-v3, aber deutlich schneller.</li>
            </ul>
        </div>

        <div class="card card-compact">
            <h5 class="font-semibold text-primary mb-3"><i class="fas fa-crosshairs"></i> Genauigkeit</h5>
            <ul class="text-sm">
                <li><strong>Medium:</strong> Guter Kompromiss für die meisten Anwendungsfälle.</li>
                <li><strong>Large-v3:</strong> Höchste Genauigkeit, ideal für professionelle Transkriptionen.</li>
            </ul>
        </div>
    </div>

    <div class="notification warning mt-4">
        <i class="fas fa-language"></i>
        <small>Die englischen Modelle (.en) sind für englische Inhalte optimiert und liefern dort bessere Ergebnisse.</small>
    </div>
</div>


<!-- Model Tabs Navigation -->
<div class="grid grid-2 mb-6">
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-star"></i> Empfohlene Modelle
            </div>
        </div>
        <div id="recommended-models-container">
            <!-- Wird per JavaScript gefüllt -->
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-list"></i> Alle Modelle
            </div>
        </div>
        <div id="all-models-container">
            <!-- Wird per JavaScript gefüllt -->
        </div>
    </div>
</div>
<!-- Download Progress Card -->
<div class="card" id="download-info" style="display: none;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-download"></i> Download läuft: <span id="current-download-model"></span>
        </div>
        <div class="text-sm text-muted">Letztes Update: <span id="last-update-time">-</span></div>
    </div>

    <div class="progress-container mb-4">
        <div class="progress-bar">
            <div class="progress-fill" id="inline-progress-bar"></div>
        </div>
        <div class="progress-text" id="inline-progress-text">0%</div>
    </div>

    <div class="status-grid">
        <div class="status-item">
            <span class="label">Größe:</span>
            <span class="value"><span id="inline-size">0</span> MB</span>
        </div>
        <div class="status-item">
            <span class="label">Heruntergeladen:</span>
            <span class="value"><span id="inline-downloaded">0</span> MB</span>
        </div>
        <div class="status-item">
            <span class="label">Geschwindigkeit:</span>
            <span class="value"><span id="inline-speed">0</span> MB/s</span>
        </div>
        <div class="status-item">
            <span class="label">Verbleibend:</span>
            <span class="value"><span id="inline-eta">Berechne...</span></span>
        </div>
    </div>

    <div class="notification info mt-4">
        <i class="fas fa-info-circle"></i>
        <code class="text-sm" id="progress-details">Warte auf Fortschrittsinformationen...</code>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// WebSocket-Verbindung initialisieren
let socket = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log("Model management page loaded.");
    
    // WebSocket beim Laden der Seite initialisieren
    connectWebSocket();
    
    const browseButton = document.getElementById('browse-model-dir');
    const progressContainer = document.getElementById('download-progress');
    const progressBar = document.getElementById('model-progress-bar');
    const recommendedModelsContainer = document.getElementById('recommended-models-container');
    const allModelsContainer = document.getElementById('all-models-container');

    // Lade Modellinformationen
    loadModels();
    
    function loadModels() {
        fetch('/api/models')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Empfohlene Modelle anzeigen
                    displayRecommendedModels(data.recommended_models);
                    
                    // Alle Modelle anzeigen (empfohlene + legacy)
                    displayAllModels(data.recommended_models, data.legacy_models);
                } else {
                    console.error('Fehler beim Laden der Modelle:', data.error);
                }
            })
            .catch(error => {
                console.error('Fehler beim Laden der Modelle:', error);
            });
    }
    
    function displayRecommendedModels(models) {
        recommendedModelsContainer.innerHTML = '';
        models.forEach(model => {
            const modelCard = document.createElement('div');
            modelCard.className = 'card card-compact mb-3';
            modelCard.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <h6 class="font-semibold text-dark">${model.name}</h6>
                        <p class="text-sm text-muted mb-2">${model.description}</p>
                        <p class="text-xs text-light">${model.recommendation}</p>
                        <div class="flex items-center gap-4 mt-2">
                            <span class="text-sm"><i class="fas fa-hdd"></i> ${model.size_mb} MB</span>
                            ${model.is_downloaded ?
                                '<span class="status-indicator success"><i class="fas fa-check"></i> Heruntergeladen</span>' :
                                '<span class="status-indicator warning"><i class="fas fa-download"></i> Nicht heruntergeladen</span>'}
                        </div>
                    </div>
                    <div class="flex flex-col gap-2">
                        ${model.is_downloaded ?
                            '<button class="btn btn-danger btn-sm delete-btn" data-model="' + model.name + '"><i class="fas fa-trash"></i> Löschen</button>' :
                            '<button class="btn btn-primary btn-sm download-btn" data-model="' + model.name + '"><i class="fas fa-download"></i> Download</button>'}
                    </div>
                </div>
            `;
            recommendedModelsContainer.appendChild(modelCard);
        });
        attachDownloadHandlers();
    }
    
    function displayAllModels(recommendedModels, legacyModels) {
        allModelsContainer.innerHTML = '';
        const allModels = [...recommendedModels, ...legacyModels];
        allModels.forEach(model => {
            const modelCard = document.createElement('div');
            modelCard.className = 'card card-compact mb-3';
            modelCard.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <h6 class="font-semibold text-dark">${model.name}</h6>
                            ${model.is_legacy ? '<span class="status-indicator info text-xs">Legacy</span>' : ''}
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-sm"><i class="fas fa-hdd"></i> ${model.size_mb > 0 ? model.size_mb + ' MB' : 'Unbekannt'}</span>
                            ${model.is_downloaded ?
                                '<span class="status-indicator success"><i class="fas fa-check"></i> Heruntergeladen</span>' :
                                '<span class="status-indicator warning"><i class="fas fa-download"></i> Nicht heruntergeladen</span>'}
                        </div>
                    </div>
                    <div>
                        ${model.is_downloaded ?
                            '<button class="btn btn-danger btn-sm delete-btn" data-model="' + model.name + '"><i class="fas fa-trash"></i> Löschen</button>' :
                            '<button class="btn btn-primary btn-sm download-btn" data-model="' + model.name + '"><i class="fas fa-download"></i> Download</button>'}
                    </div>
                </div>
            `;
            allModelsContainer.appendChild(modelCard);
        });
        attachDownloadHandlers();
    }
    
    function attachDownloadHandlers() {
        // Bestehende Event-Handler entfernen, um Doppelbindungen zu vermeiden
        const downloadButtons = document.querySelectorAll('.download-btn');
        const deleteButtons = document.querySelectorAll('.delete-btn');
        
        downloadButtons.forEach(button => {
            button.removeEventListener('click', handleDownloadClick);
            button.addEventListener('click', handleDownloadClick);
        });
        
        deleteButtons.forEach(button => {
            button.removeEventListener('click', handleDeleteClick);
            button.addEventListener('click', handleDeleteClick);
        });
    }

    function handleDownloadClick(event) {
        const modelName = event.target.getAttribute('data-model');
        console.log(`Starting download for model: ${modelName}`);
        
        // Button während der Anfrage deaktivieren
        event.target.disabled = true;
        event.target.textContent = 'Wird angefordert...';
        
        // Alle anderen Download-Buttons deaktivieren
        document.querySelectorAll('.download-btn').forEach(btn => {
            if (btn !== event.target) {
                btn.disabled = true;
                btn.title = 'Es läuft bereits ein Download';
            }
        });

        // Zeige Fortschrittsanzeige direkt im Hauptbereich
        document.getElementById('download-info').style.display = 'block';
        document.getElementById('current-download-model').textContent = modelName;
        
        fetch(`/api/models/download/${modelName}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Download request response:', data);
            // Der Rest wird durch den WebSocket-Handler erledigt
        })
        .catch(error => {
            console.error('Error requesting model download:', error);
            alert(`Fehler bei der Anfrage für ${modelName}.`);
            resetDownloadUI();
        });
    }

    function handleDeleteClick(event) {
        const modelName = event.target.getAttribute('data-model');
        console.log(`Requesting deletion for model: ${modelName}`);
        
        // Button während der Anfrage deaktivieren
        event.target.disabled = true;
        event.target.textContent = 'Wird gelöscht...';
        
        fetch(`/api/models/delete/${modelName}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Delete request response:', data);
            if (data.success) {
                alert(`Modell ${modelName} erfolgreich gelöscht!`);
                loadModels();
            } else {
                alert(`Fehler beim Löschen des Modells ${modelName}: ${data.error}`);
                event.target.disabled = false;
                event.target.textContent = 'Löschen';
            }
        })
        .catch(error => {
            console.error('Error requesting model deletion:', error);
            alert(`Fehler bei der Anfrage für ${modelName}.`);
            event.target.disabled = false;
            event.target.textContent = 'Löschen';
        });
    }

    // Verzeichnis-Auswahl
    browseButton.addEventListener('click', function() {
        alert("Funktion zum Ändern des Verzeichnisses noch nicht implementiert.");
        // In einer Produktionsversion würde hier ein Verzeichnisauswahl-Dialog geöffnet
    });

    // Handler für das Setzen des Modell-Verzeichnisses
    const setDirectoryBtn = document.getElementById('set-directory-btn');
    const newDirectoryInput = document.getElementById('new-model-directory');

    setDirectoryBtn.addEventListener('click', () => {
        const newPath = newDirectoryInput.value.trim();
        if (!newPath) {
            alert('Bitte gib einen Pfad für das Modell-Verzeichnis ein.');
            return;
        }

        console.log(`Sende Anfrage zum Setzen des Verzeichnisses auf: ${newPath}`);

        fetch('/api/models/set-directory', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ directory: newPath })
        })
        .then(response => {
            if (!response.ok) {
                // Versuche, Fehlerdetails aus der JSON-Antwort zu lesen
                return response.json().then(err => {
                    throw new Error(err.detail || `HTTP-Fehler ${response.status}`);
                }).catch(() => {
                     // Fallback, wenn keine JSON-Antwort vorhanden ist
                    throw new Error(`HTTP-Fehler ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Antwort vom Server (Verzeichnis setzen):', data);
            if (data.status === 'success') {
                alert(data.message || 'Modellverzeichnis erfolgreich aktualisiert!');
                window.location.reload(); // Seite neu laden, um Änderungen anzuzeigen
            } else {
                alert(`Fehler: ${data.message || 'Unbekannter Fehler beim Setzen des Verzeichnisses.'}`);
            }
        })
        .catch(error => {
            console.error('Fehler beim Setzen des Modell-Verzeichnisses:', error);
            alert(`Ein Fehler ist aufgetreten: ${error.message}`);
        });
    });
});

// --- WebSocket Logic for Progress Updates ---

let currentDownloadingModel = null; // Track which model's progress is shown

// Function to format ETA seconds into minutes/seconds string
function formatEta(seconds) {
    if (seconds === null || seconds === undefined || seconds < 0) return 'N/A';
    if (seconds === 0) return 'Fertig';
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.round(seconds % 60);
    let etaStr = '';
    if (minutes > 0) {
        etaStr += `${minutes} Min `;
    }
    etaStr += `${remainingSeconds} Sek`;
    return etaStr;
}

// Hilfsfunktion zum Zurücksetzen der Download-UI
function resetDownloadUI() {
    // Verstecke Fortschrittsanzeige
    document.getElementById('download-info').style.display = 'none';

    // Setze Fortschrittsbalken zurück
    const progressBar = document.getElementById('inline-progress-bar');
    const progressText = document.getElementById('inline-progress-text');
    progressBar.style.width = '0%';
    if (progressText) {
        progressText.textContent = '0%';
    }

    // Aktiviere alle Download-Buttons wieder
    document.querySelectorAll('.download-btn').forEach(btn => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-download"></i> Download';
        btn.title = '';
    });

    currentDownloadingModel = null;
}

// Socket ist bereits global definiert

function connectWebSocket() {
    // Schließe bestehende Verbindung, falls vorhanden
    if (socket && socket.readyState !== WebSocket.CLOSED) {
        console.log('Closing existing WebSocket connection');
        socket.close();
    }
    
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws/progress`;
    console.log(`Connecting to WebSocket: ${wsUrl}`);

    // Neue Verbindung herstellen
    socket = new WebSocket(wsUrl);

    socket.onopen = (event) => {
        console.log('WebSocket connection established successfully.');
        document.getElementById('progress-details').textContent = 'WebSocket verbunden. Bereit für Updates.';
        
        // DEBUG: Ping senden, um zu testen, ob die Verbindung aktiv ist
        setTimeout(() => {
            try {
                socket.send('ping');
                console.log('Ping sent to server');
            } catch (error) {
                console.error('Error sending ping:', error);
            }
        }, 1000);
    };

    socket.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            console.log('WebSocket message received:', data);
            console.info(`Progress Update: ${data.model_name || 'unknown'} - ${data.status || 'unknown'} - ${data.progress || 0}%`);
            
            // Zeige die inline-Fortschrittsanzeige an
            if (data.status === 'starting' || data.status === 'downloading') {
                currentDownloadingModel = data.model_name;
                document.getElementById('download-info').style.display = 'block';
                
                // Zeige detaillierte Modellname und Status an
                const modelName = data.model_name;
                const statusText = data.status === 'starting' ? 'Starte Download...' : 'Wird heruntergeladen...';
                document.getElementById('current-download-model').textContent = `${modelName} (${statusText})`;
                
                // Füge Zeitstempel hinzu
                const timestamp = new Date().toLocaleTimeString();
                document.getElementById('last-update-time').textContent = timestamp;
                
                // Update des inline Fortschrittsbalkens
                const inlineProgressBar = document.getElementById('inline-progress-bar');
                const inlineProgressText = document.getElementById('inline-progress-text');
                inlineProgressBar.style.width = `${data.progress}%`;
                if (inlineProgressText) {
                    inlineProgressText.textContent = `${data.progress}%`;
                }
                
                // Update der Statuswerte mit Formatierung
                document.getElementById('inline-size').textContent = data.total_size_mb;
                document.getElementById('inline-downloaded').textContent = data.downloaded_mb;
                document.getElementById('inline-speed').textContent = data.speed_mbps;
                document.getElementById('inline-eta').textContent = formatEta(data.eta_seconds);
                document.getElementById('progress-details').textContent = data.status;
                inlineProgressBar.classList.remove('bg-danger', 'bg-success');
                inlineProgressBar.classList.add('progress-bar-animated', 'progress-bar-striped');
            } else if (data.status === 'finished') {
                const inlineProgressBar = document.getElementById('inline-progress-bar');
                const inlineProgressText = document.getElementById('inline-progress-text');
                inlineProgressBar.style.width = '100%';
                if (inlineProgressText) {
                    inlineProgressText.textContent = '100%';
                }
                document.getElementById('progress-details').textContent = 'Download abgeschlossen';
                setTimeout(() => {
                    resetDownloadUI();
                    loadModels();
                }, 2000);
            } else if (data.status === 'error' || data.status === 'failed') {
                const inlineProgressBar = document.getElementById('inline-progress-bar');
                const inlineProgressText = document.getElementById('inline-progress-text');
                inlineProgressBar.style.width = '100%';
                if (inlineProgressText) {
                    inlineProgressText.textContent = 'Fehler';
                }
                document.getElementById('progress-details').textContent = 'Fehler: ' + (data.message || 'Unbekannter Fehler');
                setTimeout(() => {
                    resetDownloadUI();
                    loadModels();
                }, 5000);
            }
        } catch (error) {
            console.error('Error processing WebSocket message:', error);
        }
    };

socket.onerror = (error) => {
    console.error('WebSocket Error:', error);
    // Zeige Fehler in der Inline-Anzeige
    const inlineProgressBar = document.getElementById('inline-progress-bar');
    inlineProgressBar.classList.add('bg-danger');
    inlineProgressBar.textContent = 'Verbindungsfehler';
    
    setTimeout(() => {
        resetDownloadUI();  // Nach einigen Sekunden UI zurücksetzen
    }, 3000);
};

    socket.onclose = (event) => {
        console.log(`WebSocket connection closed: ${event.code} ${event.reason}`);
        // If the connection closes unexpectedly while downloading, show error
        if (currentDownloadingModel && (event.code !== 1000)) { // 1000 = Normal closure
            const progressDetails = document.getElementById('progress-details');
            if (progressDetails) {
                progressDetails.textContent = 'Verbindung zum Server verloren';
            }
        }
        setTimeout(connectWebSocket, 3000); // Attempt to reconnect after 3 seconds
    };
}

// Initial WebSocket connection
connectWebSocket();
</script>
{% endblock %}
