{% extends "base.html" %}

{% block content %}
<div class="phone-section">
    <div class="tabs-container">
        <div class="tabs">
            <div class="tab active" id="tab-upload">Dateien hochladen</div>
            <div class="tab" id="tab-record">Live-Aufnahme</div>
        </div>
        
        <div class="tab-content active" id="content-upload">
            <div class="upload-container">
        <form id="phone-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="track-a">Erste Audiospur (Anrufer A):</label>
                <input type="file" id="track-a" name="track_a" accept="audio/*" required>
                <small>Erste Audiospur des Telefongesprächs</small>
            </div>
            
            <div class="form-group">
                <label for="track-b">Zweite Audiospur (Anrufer B):</label>
                <input type="file" id="track-b" name="track_b" accept="audio/*" required>
                <small>Zweite Audiospur des Telefongesprächs</small>
            </div>
            
            <button type="submit" class="button primary" id="process-button">
                <i class="fas fa-phone"></i> Telefonaufnahmen verarbeiten
            </button>
        </form>
    </div>
        </div>
        
        <div class="tab-content" id="content-record">
            <div class="recording-container">
                <div class="device-selection">
                    <h3>Geräteauswahl</h3>
                    <div class="form-group">
                        <label for="input-device">Mikrofon:</label>
                        <select id="input-device" class="device-select">
                            <option value="">Wird geladen...</option>
                        </select>
                        <small>Audioquelle für Ihre Stimme</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="output-device">System-Audio (BlackHole):</label>
                        <select id="output-device" class="device-select">
                            <option value="">Wird geladen...</option>
                        </select>
                        <small>Audioquelle für Gesprächspartner</small>
                    </div>
                    
                    <button id="refresh-devices" class="button secondary">
                        <i class="fas fa-sync"></i> Geräte aktualisieren
                    </button>
                    
                    <div id="blackhole-check" class="device-check warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>BlackHole-Status wird geprüft...</span>
                    </div>
                </div>
                
                <div class="recording-controls">
                    <h3>Aufnahmesteuerung</h3>
                    <div class="controls-container">
                        <button id="start-recording" class="button primary">
                            <i class="fas fa-circle"></i> Aufnahme starten
                        </button>
                        <button id="pause-recording" class="button secondary" disabled>
                            <i class="fas fa-pause"></i> Pause
                        </button>
                        <button id="stop-recording" class="button danger" disabled>
                            <i class="fas fa-stop"></i> Beenden
                        </button>
                    </div>
                    
                    <div id="recording-timer" class="timer" style="display: none;">
                        <span id="timer-display">00:00</span>
                    </div>
                    
                    <div id="recording-status" class="status-display">
                        <span>Bereit</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="result-container" id="result-container" style="display: none;">
        <h3>Verarbeitungsergebnis</h3>
        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div id="processing-result"></div>
        <div class="action-buttons" id="action-buttons" style="display: none;">
            <button class="button" id="view-button">
                <i class="fas fa-eye"></i> Transkript anzeigen
            </button>
            <button class="button" id="download-button">
                <i class="fas fa-download"></i> Transkript herunterladen
            </button>
            <button class="button" id="analyze-button">
                <i class="fas fa-robot"></i> Mit Chatbot analysieren
            </button>
        </div>
        
        <!-- Bereich für aufgenommene Audiodateien -->
        <div class="recording-files" id="recording-files" style="display: none; margin-top: 20px;">
            <h3>Aufgenommene Audiodateien</h3>
            <div class="file-list" id="file-list">
                <!-- Hier werden die aufgenommenen Dateien angezeigt -->
            </div>
            
            <div class="mt-3">
                <button class="button primary" id="transcribe-now-button">
                    <i class="fas fa-file-audio"></i> Zur Transkription senden
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab Navigation
    const tabUpload = document.getElementById('tab-upload');
    const tabRecord = document.getElementById('tab-record');
    const contentUpload = document.getElementById('content-upload');
    const contentRecord = document.getElementById('content-record');
    
    tabUpload.addEventListener('click', function() {
        tabUpload.classList.add('active');
        tabRecord.classList.remove('active');
        contentUpload.classList.add('active');
        contentRecord.classList.remove('active');
    });
    
    tabRecord.addEventListener('click', function() {
        tabRecord.classList.add('active');
        tabUpload.classList.remove('active');
        contentRecord.classList.add('active');
        contentUpload.classList.remove('active');
        loadAudioDevices();
    });
    
    // ===== Dateiupload-Logik =====
    const form = document.getElementById('phone-form');
    const resultContainer = document.getElementById('result-container');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const processingResult = document.getElementById('processing-result');
    const actionButtons = document.getElementById('action-buttons');
    const viewButton = document.getElementById('view-button');
    const downloadButton = document.getElementById('download-button');
    const analyzeButton = document.getElementById('analyze-button');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Formular-Daten sammeln
        const formData = new FormData(form);
        
        // UI aktualisieren
        resultContainer.style.display = 'block';
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        processingResult.innerHTML = '<p>Verarbeitung der Telefonaufnahmen wird gestartet...</p>';
        actionButtons.style.display = 'none';
        
        // Verarbeitung starten
        fetch('/api/phone', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Netzwerkfehler: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            progressContainer.style.display = 'none';
            
            if (data.success) {
                processingResult.innerHTML = `
                    <div class="success-message">
                        <i class="fas fa-check-circle"></i> Verarbeitung erfolgreich!
                    </div>
                    <div class="result-info">
                        <p><strong>Erste Audiospur:</strong> ${data.track_a}</p>
                        <p><strong>Zweite Audiospur:</strong> ${data.track_b}</p>
                        <p><strong>Ausgabedatei:</strong> ${data.output_file}</p>
                    </div>
                `;
                
                // Aktionsbuttons anzeigen
                actionButtons.style.display = 'flex';
                
                // Transkript-Anzeige-Button konfigurieren
                viewButton.onclick = function() {
                    // Hier würden wir normalerweise das Transkript vom Server laden
                    // Für dieses Beispiel zeigen wir eine vereinfachte Ansicht
                    processingResult.innerHTML += `
                        <div class="transcript-view">
                            <h4>Transkript-Vorschau</h4>
                            <div class="transcript-content">
                                <p><strong>Anrufer A:</strong> Hallo, wie kann ich Ihnen helfen?</p>
                                <p><strong>Anrufer B:</strong> Ich habe eine Frage zu meiner Bestellung.</p>
                                <p><strong>Anrufer A:</strong> Natürlich, können Sie mir Ihre Bestellnummer mitteilen?</p>
                                <p><strong>Anrufer B:</strong> Ja, es ist AB12345.</p>
                                <p>...</p>
                            </div>
                        </div>
                    `;
                };
                
                // Download-Button konfigurieren
                downloadButton.onclick = function() {
                    alert('Das Transkript wurde auf dem Server unter ' + data.output_file + ' gespeichert.');
                };
                
                // Analyse-Button konfigurieren
                analyzeButton.onclick = function() {
                    window.location.href = '/chatbot?transcript=' + encodeURIComponent(data.output_file);
                };
            } else {
                processingResult.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i> Fehler bei der Verarbeitung
                    </div>
                    <p>${data.error || 'Unbekannter Fehler'}</p>
                `;
            }
        })
        .catch(error => {
            progressContainer.style.display = 'none';
            processingResult.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i> Fehler bei der Verarbeitung
                </div>
                <p>${error.message}</p>
            `;
        });
        
        // Simulierter Fortschritt (da wir keinen echten Fortschritt vom Server bekommen)
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 1;
            if (progress > 95) {
                clearInterval(progressInterval);
            } else {
                progressBar.style.width = progress + '%';
            }
        }, 500);
    });
    
    // ===== Aufnahme-Logik =====
    const inputDeviceSelect = document.getElementById('input-device');
    const outputDeviceSelect = document.getElementById('output-device');
    const refreshDevicesBtn = document.getElementById('refresh-devices');
    const blackholeCheck = document.getElementById('blackhole-check');
    const startRecordingBtn = document.getElementById('start-recording');
    const pauseRecordingBtn = document.getElementById('pause-recording');
    const stopRecordingBtn = document.getElementById('stop-recording');
    const recordingTimer = document.getElementById('recording-timer');
    const timerDisplay = document.getElementById('timer-display');
    const recordingStatus = document.getElementById('recording-status');
    
    let activeSessionId = null;
    let timerInterval = null;
    let recordingSeconds = 0;
    
    // Audiogeräte laden
    function loadAudioDevices() {
        fetch('/api/phone/devices')
            .then(response => response.json())
            .then(data => {
                // Eingabegeräte
                inputDeviceSelect.innerHTML = '';
                data.input_devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.text = device.name;
                    if (device.is_default) {
                        option.selected = true;
                    }
                    inputDeviceSelect.appendChild(option);
                });
                
                // Ausgabegeräte
                outputDeviceSelect.innerHTML = '';
                data.output_devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.text = device.name;
                    if (device.name.includes('BlackHole')) {
                        option.selected = true;
                    }
                    outputDeviceSelect.appendChild(option);
                });
                
                // BlackHole-Status prüfen
                if (data.blackhole_found) {
                    blackholeCheck.className = 'device-check success';
                    blackholeCheck.innerHTML = '<i class="fas fa-check-circle"></i> <span>BlackHole erkannt und bereit</span>';
                    startRecordingBtn.disabled = false;
                } else {
                    blackholeCheck.className = 'device-check error';
                    blackholeCheck.innerHTML = `
                        <i class="fas fa-times-circle"></i> 
                        <span>BlackHole nicht gefunden. Bitte installieren Sie es mit: <code>brew install --cask blackhole-2ch</code></span>
                    `;
                    startRecordingBtn.disabled = true;
                }
            })
            .catch(error => {
                console.error('Fehler beim Laden der Audiogeräte:', error);
                blackholeCheck.className = 'device-check error';
                blackholeCheck.innerHTML = `
                    <i class="fas fa-times-circle"></i> 
                    <span>Fehler: ${error.message}</span>
                `;
            });
    }
    
    // Aufnahmetimer aktualisieren
    function updateTimer() {
        recordingSeconds += 1;
        const minutes = Math.floor(recordingSeconds / 60);
        const seconds = recordingSeconds % 60;
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Aufnahme starten
    function startRecording() {
        const inputDeviceId = inputDeviceSelect.value;
        const outputDeviceId = outputDeviceSelect.value;
        
        if (!inputDeviceId || !outputDeviceId) {
            alert('Bitte wählen Sie Eingabe- und Ausgabegeräte aus.');
            return;
        }
        
        // Aufnahme-API aufrufen
        fetch('/api/phone/recording/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                input_device_id: inputDeviceId,
                output_device_id: outputDeviceId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                activeSessionId = data.session_id;
                
                // UI aktualisieren
                startRecordingBtn.disabled = true;
                pauseRecordingBtn.disabled = false;
                stopRecordingBtn.disabled = false;
                inputDeviceSelect.disabled = true;
                outputDeviceSelect.disabled = true;
                refreshDevicesBtn.disabled = true;
                
                // Timer starten
                recordingSeconds = 0;
                recordingTimer.style.display = 'block';
                timerInterval = setInterval(updateTimer, 1000);
                
                // Status aktualisieren
                recordingStatus.innerHTML = '<span class="recording">Aufnahme läuft...</span>';
            } else {
                alert(`Fehler beim Starten der Aufnahme: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Fehler:', error);
            alert(`Netzwerkfehler: ${error.message}`);
        });
    }
    
    // Aufnahme pausieren
    function pauseRecording() {
        if (!activeSessionId) return;
        
        fetch(`/api/phone/recording/${activeSessionId}/pause`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Timer pausieren
                clearInterval(timerInterval);
                timerInterval = null;
                
                // UI aktualisieren
                pauseRecordingBtn.disabled = true;
                startRecordingBtn.disabled = false;
                startRecordingBtn.innerHTML = '<i class="fas fa-play"></i> Fortsetzen';
                
                // Status aktualisieren
                recordingStatus.innerHTML = '<span class="paused">Aufnahme pausiert</span>';
            } else {
                alert(`Fehler: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Fehler:', error);
            alert(`Netzwerkfehler: ${error.message}`);
        });
    }
    
    // Aufnahme fortsetzen
    function resumeRecording() {
        if (!activeSessionId) return;
        
        fetch(`/api/phone/recording/${activeSessionId}/resume`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Timer fortsetzen
                timerInterval = setInterval(updateTimer, 1000);
                
                // UI aktualisieren
                startRecordingBtn.disabled = true;
                pauseRecordingBtn.disabled = false;
                startRecordingBtn.innerHTML = '<i class="fas fa-circle"></i> Aufnahme starten';
                
                // Status aktualisieren
                recordingStatus.innerHTML = '<span class="recording">Aufnahme läuft...</span>';
            } else {
                alert(`Fehler: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Fehler:', error);
            alert(`Netzwerkfehler: ${error.message}`);
        });
    }
    
    // Aufnahme beenden
    function stopRecording() {
        if (!activeSessionId) return;
        
        fetch(`/api/phone/recording/${activeSessionId}/stop`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            // Timer stoppen und UI zurücksetzen
            clearInterval(timerInterval);
            timerInterval = null;
            inputDeviceSelect.disabled = false;
            outputDeviceSelect.disabled = false;
            refreshDevicesBtn.disabled = false;
            startRecordingBtn.disabled = false;
            pauseRecordingBtn.disabled = true;
            stopRecordingBtn.disabled = true;
            startRecordingBtn.innerHTML = '<i class="fas fa-circle"></i> Aufnahme starten';
            activeSessionId = null;
            
            if (data.success) {
                // Erfolgsanzeige
                recordingStatus.innerHTML = `
                    <div class="success-message">
                        <i class="fas fa-check-circle"></i> Aufnahme abgeschlossen!
                    </div>
                    <div class="result-info">
                        <p><strong>Mikrofonkanal:</strong> ${data.files.microphone}</p>
                        <p><strong>Systemkanal:</strong> ${data.files.system}</p>
                    </div>
                    <button class="button primary" onclick="processRecording('${data.session_id}')">
                        <i class="fas fa-cogs"></i> Aufnahme verarbeiten
                    </button>
                `;
            } else {
                // Fehlermeldung anzeigen
                recordingStatus.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i> ${data.message || data.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Fehler:', error);
            alert(`Netzwerkfehler: ${error.message}`);
        });
    }
    
    // Aufnahme verarbeiten und transkribieren
    function processRecording(sessionId) {
        // Fortschrittsanzeige anzeigen
        resultContainer.style.display = 'block';
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        processingResult.innerHTML = '<p>Aufnahme wird vorbereitet...</p>';
        actionButtons.style.display = 'none';
        
        // Audiodateien vom Server abrufen
        fetch(`/api/phone/recording/${sessionId}/process`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            progressContainer.style.display = 'none';
            
            if (data.success && data.audio_files && data.audio_files.length > 0) {
                // Erfolgsanzeige
                processingResult.innerHTML = `
                    <div class="success-message">
                        <i class="fas fa-check-circle"></i> Aufnahme erfolgreich verarbeitet!
                    </div>
                    <div class="info-message">
                        <p>Die Aufnahme wird zur Transkriptionsseite weitergeleitet...</p>
                    </div>
                `;
                
                // Kurze Verzögerung und dann zur Transkriptionsseite weiterleiten
                setTimeout(() => {
                    // Audiodateien an die Transkriptionsseite senden
                    sendToTranscriptionPage(data.audio_files, sessionId);
                }, 1500);
                
            } else {
                // Fehlermeldung anzeigen
                processingResult.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i> Fehler bei der Verarbeitung
                    </div>
                    <p>${data.error || 'Keine Audiodateien gefunden.'}</p>
                `;
            }
        })
        .catch(error => {
            progressContainer.style.display = 'none';
            processingResult.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i> Fehler bei der Verarbeitung
                </div>
                <p>${error.message}</p>
            `;
        });
        
        // Simulierter Fortschritt (bis Echtzeit-Fortschritt implementiert ist)
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 1;
            if (progress > 95) {
                clearInterval(progressInterval);
            } else {
                progressBar.style.width = progress + '%';
            }
        }, 500);
    }
    
    // Funktion zum Anzeigen der aufgenommenen Audiodateien
    function displayRecordingFiles(audioFiles, sessionId) {
        if (!audioFiles || audioFiles.length === 0) {
            return;
        }
        
        const fileListContainer = document.getElementById('file-list');
        const recordingFilesSection = document.getElementById('recording-files');
        
        // HTML für Dateiliste erstellen
        let filesHtml = '';
        
        audioFiles.forEach(file => {
            const fileName = file.path ? file.path.split('/').pop() : 'aufnahme.wav';
            const fileType = file.type || 'audio';
            const fileIcon = fileType.includes('mic') ? 'microphone' : 'volume-up';
            const filePath = file.path || file;  // Manchmal ist es nur ein Dateipfad-String
            
            filesHtml += `
                <div class="file-item" data-path="${filePath}">
                    <i class="fas fa-${fileIcon}"></i>
                    <span>${fileName}</span>
                    <div class="file-actions">
                        <button class="button small play-audio" data-path="${filePath}">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        // Dateiliste setzen und anzeigen
        fileListContainer.innerHTML = filesHtml;
        recordingFilesSection.style.display = 'block';
        
        // Event-Handler für Audiowiedergabe
        const playButtons = document.querySelectorAll('.play-audio');
        playButtons.forEach(button => {
            button.addEventListener('click', function() {
                const audioPath = this.getAttribute('data-path');
                const audio = new Audio(audioPath);
                audio.play();
            });
        });
        
        // Event-Handler für "Zur Transkription senden"-Button
        const transcribeNowButton = document.getElementById('transcribe-now-button');
        if (transcribeNowButton) {
            transcribeNowButton.addEventListener('click', function() {
                sendToTranscriptionPage(audioFiles, sessionId);
            });
        }
    }
    
    // Funktion zum Senden der Audiodateien an die Transkriptionsseite
    function sendToTranscriptionPage(audioFiles, sessionId) {
        if (!audioFiles || audioFiles.length === 0) {
            alert('Keine Audiodateien zum Transkribieren verfügbar.');
            return;
        }
        
        // Pfade der Audiodateien auslesen
        const micFile = audioFiles.find(f => (f.type || '').includes('mic'))?.path || audioFiles[0];
        const sysFile = audioFiles.find(f => (f.type || '').includes('sys'))?.path || (audioFiles.length > 1 ? audioFiles[1] : null);
        
        // URL-Parameter generieren - ähnlich wie bei Videoextraktion
        let url = '/transcribe?';
        // Mikrofonaufnahme als Hauptaudiopfad
        if (micFile) url += 'audio=' + encodeURIComponent(micFile);
        // System-Audio als zweiten Parameter
        if (sysFile) url += '&system_audio=' + encodeURIComponent(sysFile);
        // Session-ID mitgeben
        url += '&session_id=' + encodeURIComponent(sessionId);
        // Sprache auf Deutsch setzen, da die meisten Inhalte Deutsch sind
        url += '&language=de';
        
        // Zur Transkriptionsseite mit Parametern wechseln
        window.location.href = url;
    }
    
    // Beim ersten Tab-Wechsel Geräte laden
    if (tabRecord.classList.contains('active')) {
        loadAudioDevices();
    }
    
    // Event-Handler registrieren
    refreshDevicesBtn.addEventListener('click', loadAudioDevices);
    
    startRecordingBtn.addEventListener('click', function() {
        if (startRecordingBtn.innerHTML.includes('Fortsetzen')) {
            resumeRecording();
        } else {
            startRecording();
        }
    });
    
    pauseRecordingBtn.addEventListener('click', pauseRecording);
    stopRecordingBtn.addEventListener('click', stopRecording);
});
</script>
{% endblock %}
