{% extends "base.html" %}

{% block content %}
<div class="chatbot-section">
    <div class="chatbot-container">
        <div class="transcript-upload">
            <h3>Transkript hochladen (optional)</h3>
            <form id="transcript-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="transcript-file">Transkriptdatei:</label>
                    <input type="file" id="transcript-file" name="transcript_file" accept=".txt,.srt,.vtt,.json">
                    <small>Unterstützte Formate: TXT, SRT, VTT, JSON</small>
                </div>
                <button type="submit" class="button" id="upload-button">
                    <i class="fas fa-upload"></i> Hochladen
                </button>
            </form>
        </div>
        
        <div class="chat-interface">
            <h3>Chatbot zur Transkriptanalyse</h3>
            <div class="chat-messages" id="chat-messages">
                <div class="message system">
                    <div class="message-content">
                        <p>Willkommen beim Transkriptanalyse-Chatbot. Wie kann ich Ihnen helfen?</p>
                    </div>
                </div>
            </div>
            
            <div class="chat-input">
                <form id="chat-form">
                    <input type="text" id="query" name="query" placeholder="Stellen Sie eine Frage zum Transkript..." required>
                    <button type="submit" class="button primary">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="transcript-preview" id="transcript-preview" style="display: none;">
        <h3>Aktuelles Transkript</h3>
        <div class="transcript-content" id="transcript-content"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const transcriptForm = document.getElementById('transcript-form');
    const chatForm = document.getElementById('chat-form');
    const chatMessages = document.getElementById('chat-messages');
    const transcriptPreview = document.getElementById('transcript-preview');
    const transcriptContent = document.getElementById('transcript-content');
    
    let currentTranscript = null;
    
    // Transkript hochladen
    transcriptForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(transcriptForm);
        const transcriptFile = document.getElementById('transcript-file').files[0];
        
        if (!transcriptFile) {
            addMessage('system', 'Bitte wählen Sie eine Transkriptdatei aus.');
            return;
        }
        
        addMessage('system', `Transkript "${transcriptFile.name}" wird hochgeladen...`);
        
        // Datei lesen und anzeigen (vereinfachte Version, normalerweise würde dies über den Server laufen)
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            currentTranscript = {
                name: transcriptFile.name,
                content: content
            };
            
            // Transkript-Vorschau anzeigen
            transcriptPreview.style.display = 'block';
            transcriptContent.innerHTML = `<pre>${content.substring(0, 500)}${content.length > 500 ? '...' : ''}</pre>`;
            
            addMessage('system', `Transkript "${transcriptFile.name}" wurde erfolgreich geladen. Sie können jetzt Fragen dazu stellen.`);
        };
        reader.readAsText(transcriptFile);
    });
    
    // Chat-Nachricht senden
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const query = document.getElementById('query').value.trim();
        if (!query) return;
        
        // Benutzernachricht anzeigen
        addMessage('user', query);
        
        // Eingabefeld leeren
        document.getElementById('query').value = '';
        
        // Anfrage an den Server senden
        const formData = new FormData();
        formData.append('query', query);
        
        if (currentTranscript) {
            const transcriptFile = new File([currentTranscript.content], currentTranscript.name, {
                type: 'text/plain'
            });
            formData.append('transcript_file', transcriptFile);
        }
        
        // Lade-Nachricht anzeigen
        const loadingId = addMessage('system', '<i class="fas fa-spinner fa-spin"></i> Denke nach...');
        
        // Simulierte Antwort (da wir noch keine echte Chatbot-Implementierung haben)
        setTimeout(() => {
            // Lade-Nachricht entfernen
            document.getElementById(loadingId).remove();
            
            let response;
            if (currentTranscript) {
                if (query.toLowerCase().includes('zusammenfassung') || query.toLowerCase().includes('zusammenfassen')) {
                    response = 'Basierend auf dem Transkript handelt es sich um ein Gespräch zwischen zwei Personen über ein Produkt. Die Hauptpunkte sind:\n\n1. Diskussion über Produkteigenschaften\n2. Preisverhandlung\n3. Lieferoptionen\n\nMöchten Sie weitere Details zu einem bestimmten Aspekt?';
                } else if (query.toLowerCase().includes('sprecher') || query.toLowerCase().includes('personen')) {
                    response = 'Im Transkript wurden zwei Sprecher identifiziert:\n\n- Sprecher A: Vermutlich ein Verkäufer oder Berater\n- Sprecher B: Vermutlich ein Kunde oder Interessent';
                } else if (query.toLowerCase().includes('thema') || query.toLowerCase().includes('worum')) {
                    response = 'Das Hauptthema des Gesprächs ist eine Produktberatung und mögliche Kaufentscheidung. Es werden technische Details, Preise und Lieferoptionen besprochen.';
                } else {
                    response = 'Ich habe das Transkript analysiert und kann Ihnen helfen, Informationen daraus zu extrahieren. Sie können nach Zusammenfassungen, Sprechern, Themen oder spezifischen Informationen fragen.';
                }
            } else {
                response = 'Um Ihnen besser helfen zu können, laden Sie bitte ein Transkript hoch. Ohne Transkript kann ich nur allgemeine Fragen beantworten.';
            }
            
            addMessage('bot', response);
        }, 1500);
    });
    
    // Hilfsfunktion zum Hinzufügen von Nachrichten
    function addMessage(sender, content) {
        const messageId = 'msg-' + Date.now();
        const messageDiv = document.createElement('div');
        messageDiv.id = messageId;
        messageDiv.className = `message ${sender}`;
        messageDiv.innerHTML = `
            <div class="message-content">
                <p>${content}</p>
            </div>
        `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return messageId;
    }
    
    // URL-Parameter prüfen, ob ein Transkript angegeben wurde
    const urlParams = new URLSearchParams(window.location.search);
    const transcriptParam = urlParams.get('transcript');
    if (transcriptParam) {
        addMessage('system', `Transkript "${transcriptParam}" wird geladen...`);
        
        // Hier würden wir normalerweise das Transkript vom Server laden
        // Für dieses Beispiel zeigen wir eine Platzhalternachricht
        setTimeout(() => {
            currentTranscript = {
                name: transcriptParam.split('/').pop(),
                content: 'Anrufer A: Hallo, wie kann ich Ihnen helfen?\nAnrufer B: Ich habe eine Frage zu meiner Bestellung.\nAnrufer A: Natürlich, können Sie mir Ihre Bestellnummer mitteilen?\nAnrufer B: Ja, es ist AB12345.'
            };
            
            // Transkript-Vorschau anzeigen
            transcriptPreview.style.display = 'block';
            transcriptContent.innerHTML = `<pre>${currentTranscript.content}</pre>`;
            
            addMessage('system', `Transkript "${currentTranscript.name}" wurde erfolgreich geladen. Sie können jetzt Fragen dazu stellen.`);
        }, 1000);
    }
});
</script>
{% endblock %}
