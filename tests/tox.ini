[tox]
envlist = py{39,310,311,312}, coverage, docs, lint
skip_missing_interpreters = true

[testenv]
deps =
    pytest>=7.0
    pytest-cov
    pytest-asyncio
    pytest-timeout
    pytest-mock
    pytest-xdist
extras = test

commands =
    pytest tests/unit -v --tb=short --cov=src --cov-report=term-missing

[testenv:coverage]
deps =
    {[testenv]deps}
    coverage[toml]

commands =
    coverage erase
    pytest tests -v --cov=src --cov-report=html --cov-report=xml --cov-report=term-missing
    coverage report --fail-under=80

[testenv:integration]
deps = {[testenv]deps}
commands =
    pytest tests/integration -v --tb=short -m "not requires_model"

[testenv:performance]
deps =
    {[testenv]deps}
    pytest-benchmark
    psutil

commands =
    pytest tests/performance -v --tb=short -m "not slow"

[testenv:lint]
deps =
    flake8
    black
    isort
    mypy
    pylint

commands =
    black --check src tests
    isort --check-only src tests
    flake8 src tests
    mypy src --ignore-missing-imports
    pylint src

[testenv:format]
deps =
    black
    isort

commands =
    black src tests
    isort src tests

[testenv:security]
deps =
    safety
    bandit

commands =
    safety check
    bandit -r src

[testenv:docs]
deps =
    sphinx
    sphinx-rtd-theme
    sphinx-autodoc-typehints

commands =
    sphinx-build -W -b html docs docs/_build/html

[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*

markers =
    unit: Unit tests
    integration: Integration tests
    performance: Performance tests
    slow: Slow running tests
    requires_model: Tests requiring model files

[coverage:run]
source = src

[coverage:report]
exclude_lines =
    pragma: no cover
    def __repr__
    raise AssertionError
    raise NotImplementedError

[flake8]
max-line-length = 127
extend-ignore = E203, W503
exclude =
    .git,
    __pycache__,
    venv,
    venv_new,
    deps,
    WhisperLocal.app,
    scripts

[isort]
profile = black
multi_line_output = 3
line_length = 127
known_first_party = src

[mypy]
python_version = 3.9
warn_return_any = true
warn_unused_configs = true
ignore_missing_imports = true
no_implicit_optional = true