{% extends "base.html" %}

{% block content %}
<!-- Header Section -->
<div class="header-section">
    <h1><i class="fas fa-film"></i> Video zu Audio Extraktion</h1>
    <div class="status-indicator success">
        <i class="fas fa-check-circle"></i> Ready
    </div>
</div>

<!-- Main Content -->
<div class="grid grid-2">
    <!-- Left Column: Upload Form -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-upload"></i> Video Upload
            </div>
        </div>

        <form id="extract-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="video-file" class="form-label">Videodatei auswählen:</label>
                <input type="file" id="video-file" name="video_file" class="form-input"
                       accept="video/*" required>
                <small class="text-muted">Unterstützte Formate: MP4, MOV, AVI, MKV, WebM</small>

                <div class="notification info mt-4">
                    <i class="fas fa-info-circle"></i>
                    Die Audiodatei wird automatisch extrahiert und kann anschließend transkribiert werden.
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-lg" id="extract-button" style="width: 100%; margin-top: 1.5rem;">
                <i class="fas fa-film"></i> Audio extrahieren
            </button>
        </form>
    </div>

    <!-- Right Column: Progress & Results -->
    <div class="card" id="result-card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-chart-bar"></i> Extraktion & Ergebnisse
            </div>
        </div>

        <!-- Default state when no processing -->
        <div id="waiting-state">
            <div class="text-center p-8">
                <i class="fas fa-video text-4xl text-muted mb-4"></i>
                <p class="text-muted">Bereit für Video-Extraktion...</p>
                <p class="text-sm text-light">Wählen Sie eine Videodatei aus und klicken Sie "Audio extrahieren"</p>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="progress-section" style="display: none;">
            <div class="progress-container mb-4">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-bar"></div>
                </div>
                <div class="progress-text" id="progress-text">0%</div>
            </div>
            <div id="extraction-result"></div>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-4 mt-6" id="action-buttons" style="display: none;">
            <button class="btn btn-primary" id="transcribe-button">
                <i class="fas fa-microphone"></i> Jetzt transkribieren
            </button>
            <button class="btn btn-success" id="download-button">
                <i class="fas fa-download"></i> Audio herunterladen
            </button>
            <button class="btn btn-secondary" id="reset-button">
                <i class="fas fa-redo"></i> Neue Extraktion
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('extract-form');
    const waitingState = document.getElementById('waiting-state');
    const progressSection = document.getElementById('progress-section');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const extractionResult = document.getElementById('extraction-result');
    const actionButtons = document.getElementById('action-buttons');
    const transcribeButton = document.getElementById('transcribe-button');
    const downloadButton = document.getElementById('download-button');
    const resetButton = document.getElementById('reset-button');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Formular-Daten sammeln
        const formData = new FormData(form);
        
        // UI aktualisieren
        waitingState.style.display = 'none';
        progressSection.style.display = 'block';
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
        extractionResult.innerHTML = `
            <div class="notification info">
                <i class="fas fa-spinner fa-spin"></i> Audioextraktion wird gestartet...
            </div>
        `;
        actionButtons.style.display = 'none';
        
        // Extraktion starten
        fetch('/api/extract', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Netzwerkfehler: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            progressSection.style.display = 'none';

            if (data.success) {
                extractionResult.innerHTML = `
                    <div class="notification success mb-4">
                        <i class="fas fa-check-circle"></i> Audioextraktion erfolgreich!
                    </div>
                    <div class="status-grid">
                        <div class="status-item">
                            <span class="label">Videodatei:</span>
                            <span class="value">${data.video_path}</span>
                        </div>
                        <div class="status-item">
                            <span class="label">Extrahierte Audiodatei:</span>
                            <span class="value">${data.audio_path}</span>
                        </div>
                    </div>
                `;

                // Aktionsbuttons anzeigen
                actionButtons.style.display = 'flex';
                
                // Transkriptionsbutton konfigurieren
                transcribeButton.onclick = function() {
                    // Standardmäßig deutsche Sprache (de) als Parameter mitgeben, da die meisten Inhalte Deutsch sind
                    window.location.href = '/transcribe?audio=' + encodeURIComponent(data.audio_path) + '&language=de';
                };
                
                // Download-Button konfigurieren (vereinfachte Version, da direkter Download vom Server nicht möglich ist)
                downloadButton.onclick = function() {
                    alert('Die Audiodatei wurde auf dem Server unter ' + data.audio_path + ' gespeichert.');
                };
            } else {
                extractionResult.innerHTML = `
                    <div class="notification error">
                        <i class="fas fa-exclamation-circle"></i>
                        <div>
                            <strong>Fehler bei der Audioextraktion</strong>
                            <p class="mt-2">${data.error || 'Unbekannter Fehler'}</p>
                        </div>
                    </div>
                `;
                actionButtons.style.display = 'flex';
            }
        })
        .catch(error => {
            progressSection.style.display = 'none';
            extractionResult.innerHTML = `
                <div class="notification error">
                    <i class="fas fa-exclamation-circle"></i>
                    <div>
                        <strong>Fehler bei der Audioextraktion</strong>
                        <p class="mt-2">${error.message}</p>
                    </div>
                </div>
            `;
            actionButtons.style.display = 'flex';
        });
        
        // Simulierter Fortschritt (da wir keinen echten Fortschritt vom Server bekommen)
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 2;
            if (progress > 95) {
                clearInterval(progressInterval);
            } else {
                progressBar.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '%';
            }
        }, 300);
    });

    // Reset button handler
    if (resetButton) {
        resetButton.addEventListener('click', function() {
            // Reset UI to initial state
            waitingState.style.display = 'block';
            progressSection.style.display = 'none';
            extractionResult.innerHTML = '';
            actionButtons.style.display = 'none';

            // Reset form
            form.reset();
        });
    }
});
</script>
{% endblock %}
